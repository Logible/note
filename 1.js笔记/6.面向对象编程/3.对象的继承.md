# å¯¹è±¡çš„ç»§æ‰¿

## 1.åŸå‹å¯¹è±¡æ¦‚è¿°

### 1.1 æ„é€ å‡½æ•°çš„ç¼ºç‚¹

é€šè¿‡æ„é€ å‡½æ•°ä¸ºå®ä¾‹å¯¹è±¡å®šä¹‰å±æ€§,è™½ç„¶å¾ˆæ–¹ä¾¿ä½†æœ‰ä¸€ä¸ªç¼ºç‚¹:

åŒä¸€ä¸ªæ„é€ å‡½æ•°çš„å¤šä¸ªå®ä¾‹ä¹‹é—´,æ— æ³•å…±äº«å±æ€§,ä»è€Œé€ æˆå¯¹ç³»ç»Ÿèµ„æºçš„æµªè´¹

```js
function Cat(name, color) {
  this.name = name;
  this.color = color;
  this.meow = function () {
    console.log('å–µå–µ');
  };
}

var cat1 = new Cat('å¤§æ¯›', 'ç™½è‰²');
var cat2 = new Cat('äºŒæ¯›', 'é»‘è‰²');

cat1.meow === cat2.meow
// false
```

### 1.2 prototypeå±æ€§çš„ä½œç”¨

JavaScriptç»§æ‰¿æœºåˆ¶çš„è®¾è®¡æ€æƒ³:

åŸå‹å¯¹è±¡çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•,éƒ½èƒ½è¢«å®ä¾‹å¯¹è±¡å…±äº«.ä¹Ÿå°±æ˜¯è¯´,è‹¥å±æ€§å’Œæ–¹æ³•å®šä¹‰åœ¨åŸå‹ä¸Š,é‚£ä¹ˆæ‰€æœ‰å®ä¾‹å¯¹è±¡å°±èƒ½å…±äº«

ğŸ‘†ä¸ä»…èŠ‚çœäº†å†…å­˜,è¿˜ä½“ç°äº†å®ä¾‹å¯¹è±¡ä¹‹é—´çš„è”ç³»

ğŸ‘‡å‡½æ•°<code style="color:#ea4335">f</code>é»˜è®¤å…·æœ‰<code style="color:#ea4335">prototype</code>å±æ€§,æŒ‡å‘ä¸€ä¸ªå¯¹è±¡

```js
function f() {}
typeof f.prototype // "object"
```

å¯¹æ™®é€šå‡½æ•°æ¥è¯´,è¯¥å±æ€§åŸºæœ¬æ— ç”¨.ä½†å¯¹äºæ„é€ å‡½æ•°æ¥è¯´,ç”Ÿæˆå®ä¾‹çš„æ—¶å€™,è¯¥å±æ€§ä¼šè‡ªåŠ¨ç§°ä¸ºå®ä¾‹å¯¹è±¡çš„åŸå‹

```js
function Animal(name) {
  this.name = name;
}
Animal.prototype.color = 'white';

var cat1 = new Animal('å¤§æ¯›');
var cat2 = new Animal('äºŒæ¯›');

cat1.color // 'white'
cat2.color // 'white'
```

- å½“å®ä¾‹å¯¹è±¡æœ¬èº«æ²¡æœ‰æŸä¸ªå±æ€§å’Œæ–¹æ³•çš„æ—¶å€™,å®ƒä¼šåˆ°åŸå‹å¯¹è±¡å»å¯»æ‰¾è¯¥å±æ€§/æ–¹æ³•
- å¦‚æœå®ä¾‹å¯¹è±¡è‡ªèº«å°±æœ‰æŸä¸ªå±æ€§æˆ–æ–¹æ³•,å®ƒå°±ä¸ä¼šå†å»åŸå‹å¯¹è±¡å¯»æ‰¾è¿™ä¸ªå±æ€§/æ–¹æ³•

```js
cat1.color = 'black';

cat1.color // 'black'
cat2.color // 'yellow'
Animal.prototype.color // 'yellow';
```

ğŸ‘‡<code style="color:#ea4335">Animal.prototype</code>å¯¹è±¡ä¸Šé¢å®šä¹‰äº†ä¸€ä¸ª<code style="color:#ea4335">walk</code>æ–¹æ³•,è¿™ä¸ªæ–¹æ³•å°†å¯ä»¥åœ¨æ‰€æœ‰<code style="color:#ea4335">Animal</code>å®ä¾‹å¯¹è±¡ä¸Šé¢è°ƒç”¨

```js
Animal.prototype.walk = function () {
  console.log(this.name + ' is walking');
};
```

æ€»ç»“:

åŸå‹å¯¹è±¡çš„ä½œç”¨,å°±æ˜¯å®šä¹‰æ‰€æœ‰å®ä¾‹å¯¹è±¡å…±äº«çš„å±æ€§å’Œæ–¹æ³•

## 1.3 åŸå‹é“¾

JavaScriptè§„å®š,æ‰€æœ‰å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„åŸå‹å¯¹è±¡(prototype)

- ä¸€æ–¹é¢,ä»»ä½•ä¸€ä¸ªå¯¹è±¡,éƒ½å¯ä»¥å……å½“å…¶ä»–å¯¹è±¡çš„åŸå‹
- å¦ä¸€æ–¹é¢,ç”±äºåŸå‹çš„å¯¹è±¡ä¹Ÿæ˜¯å¯¹è±¡,æ‰€ä»¥å®ƒä¹Ÿæœ‰è‡ªå·±çš„åŸå‹

å› æ­¤,å°±ä¼šå½¢æˆä¸€ä¸ªåŸå‹é“¾(prototype chain):å¯¹è±¡åˆ°åŸå‹,å†åˆ°åŸå‹çš„åŸå‹

æ‰€æœ‰å¯¹è±¡çš„åŸå‹éƒ½å¯ä»¥ä¸Šæº¯åˆ°<code style="color:#ea4335">Object.prototype</code>,å³<code style="color:#ea4335">Object</code>æ„é€ å‡½æ•°çš„<code style="color:#ea4335">prototype</code>å±æ€§. è¿™å°±æ˜¯æ‰€æœ‰å¯¹è±¡éƒ½æœ‰<code style="color:#ea4335">valueOf</code>å’Œ<code style="color:#ea4335">toString</code>çš„åŸå› 

<code style="color:#ea4335">Object.prototype</code>çš„åŸå‹æ˜¯<code style="color:#ea4335">null</code>.<code style="color:#ea4335">null</code>æ²¡æœ‰ä»»ä½•å±æ€§å’Œæ–¹æ³•,ä¹Ÿæ²¡æœ‰è‡ªå·±çš„åŸå‹,å› æ­¤åŸå‹é“¾çš„å°½å¤´å°±æ˜¯<code style="color:#ea4335">null</code>

```js
Object.getPrototypeOf(Object.prototype)
// null
```

ğŸ‘†<code style="color:#ea4335">Object.getPrototypeOf</code>æ–¹æ³•è¿”å›å¯¹è±¡çš„åŸå‹

è¯»å–å¯¹è±¡çš„æŸä¸ªå±æ€§æ—¶:

- JavaScriptå¼•æ“å…ˆå¯»æ‰¾å¯¹è±¡æœ¬èº«çš„å±æ€§
- å¦‚æœæ‰¾ä¸åˆ°,å°±åˆ°å®ƒçš„åŸå‹å»æ‰¾
  - å¦‚æœç›´åˆ°æœ€é¡¶å±‚çš„<code style="color:#ea4335">Object.prototype</code>è¿˜æ˜¯æ‰¾ä¸åˆ°,åˆ™è¿”å›<code style="color:#ea4335">undefined</code>

è‹¥å¯¹è±¡è‡ªèº«å’Œå®ƒçš„åŸå‹éƒ½å®šä¹‰äº†ä¸€ä¸ªåŒåå±æ€§,é‚£ä¹ˆä¼˜å…ˆè¯»å–å¯¹è±¡è‡ªèº«çš„å±æ€§,è¿™å«åš"è¦†ç›–"(overriding)

$\color{#34a853}{ä¸¾ä¾‹:}$

```js
var MyArray = function () {};

MyArray.prototype = new Array();
MyArray.prototype.constructor = MyArray;

var mine = new MyArray();
mine.push(1, 2, 3);
mine.length // 3
mine instanceof Array // true
```

### 1.4 constructorå±æ€§

<code style="color:#ea4335">prototype</code>å¯¹è±¡æœ‰ä¸€ä¸ª<code style="color:#ea4335">constructor</code>å±æ€§,é»˜è®¤æŒ‡å‘<code style="color:#ea4335">prototype</code>å¯¹è±¡æ‰€åœ¨çš„æ„é€ å‡½æ•°

```js
function P() {}
P.prototype.constructor === P // true
```

ç”±äº<code style="color:#ea4335">constructor</code>å±æ€§å®šä¹‰åœ¨<code style="color:#ea4335">prototype</code>å¯¹è±¡ä¸Šé¢,æ„å‘³ç€å¯ä»¥è¢«æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ç»§æ‰¿

```js
function P() {}
var p = new P();

p.constructor === P // true
p.constructor === P.prototype.constructor // true
p.hasOwnProperty('constructor') // false
```

<code style="color:#ea4335">constructor</code>å±æ€§çš„ä½œç”¨:

1. å¯ä»¥å¾—çŸ¥æŸä¸ªå®ä¾‹å¯¹è±¡,åˆ°åº•æ˜¯å“ªä¸€ä¸ªæ„é€ å‡½æ•°äº§ç”Ÿçš„

    ```js
    function F() {
    this.name = 'shit';
    };
    var f = new F();

    f.constructor === F // true
    f.constructor === RegExp // false

    console.log(f.constructor);
    /**
     * Æ’ F() {this.name = 'shit';}
     */
    ```

2. å¯ä»¥ä»ä¸€ä¸ªå®ä¾‹å¯¹è±¡æ–°å»ºå¦ä¸€ä¸ªå®ä¾‹

    ```js
    function Constr() {}
    var x = new Constr();

    var y = new x.constructor();
    y instanceof Constr // true
    ```

    â†“ä»£ç ä¸­,<code style="color:#ea4335">createCopy</code>æ–¹æ³•è°ƒç”¨æ„é€ å‡½æ•°,æ–°å»ºå¦ä¸€ä¸ªå®ä¾‹

    ```js
    Constr.prototype.createCopy = function () {
    return new this.constructor();
    };
    ```

$\color{#fbbc05}{Tips:}$

<code style="color:#ea4335">constructor</code>å±æ€§è¡¨ç¤ºåŸå‹å¯¹è±¡ä¸æ„é€ å‡½æ•°ä¹‹é—´çš„å…³è”å…³ç³»,å¦‚æœä¿®æ”¹äº†åŸå‹å¯¹è±¡,ä¸€èˆ¬éœ€è¦åŒæ—¶ä¿®æ”¹<code style="color:#ea4335">constructor</code>å±æ€§

```js
function Person(name) {
  this.name = name;
}

Person.prototype.constructor === Person // true

Person.prototype = {
  method: function () {}
};

Person.prototype.constructor === Person // false
Person.prototype.constructor === Object // true
```

æ‰€ä»¥ä¿®æ”¹åŸå‹å¯¹è±¡æ—¶,ä¸€èˆ¬è¦åŒæ—¶ä¿®æ”¹<code style="color:#ea4335">constructor</code>å±æ€§çš„æŒ‡å‘

```js
// åçš„å†™æ³•
C.prototype = {
  method1: function (...) { ... },
  // ...
};

// å¥½çš„å†™æ³•
C.prototype = {
  constructor: C,
  method1: function (...) { ... },
  // ...
};

// æ›´å¥½çš„å†™æ³•
C.prototype.method1 = function (...) { ... };
```

ğŸ‘†è¦ä¹ˆå°†<code style="color:#ea4335">constructor</code>å±æ€§æŒ‡å‘åŸæ¥çš„æ„é€ å‡½æ•°,è¦ä¹ˆåªåœ¨åŸå‹å¯¹è±¡ä¸Šæ·»åŠ æ–¹æ³•,è¿™æ ·å¯ä»¥ä¿è¯<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦ä¸ä¼šå¤±çœŸ

è·å–æ„é€ å‡½æ•°åç§°çš„æ–¹æ³•:

```js
function Foo() {}
var f = new Foo();
f.constructor.name // "Foo"
```

## 2.instanceofè¿ç®—ç¬¦

<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼,è¡¨ç¤ºå¯¹è±¡æ˜¯å¦ä¸ºæŸä¸ªæ„é€ å‡½æ•°çš„å®ä¾‹

```js
var v = new Vehicle();
v instanceof Vehicle // true
```

<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦å·¦è¾¹æ˜¯å®ä¾‹å¯¹è±¡,å³è¾¹æ˜¯æ„é€ å‡½æ•°.å®ƒä¼šæ£€æŸ¥å³è¾¹æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡(prototype),æ˜¯å¦åœ¨å·¦è¾¹å¯¹è±¡çš„åŸå‹é“¾ä¸Š,ğŸ‘‡ä¸¤ç§å†™æ³•æ˜¯ç­‰ä»·çš„

```js
v instanceof Vehicle
// ç­‰åŒäº
Vehicle.prototype.isPrototypeOf(v)
```

- ç”±äº<code style="color:#ea4335">instanceof</code>æ£€æŸ¥æ•´ä¸ªåŸå‹é“¾,å› æ­¤åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡,å¯èƒ½ä¼šå¯¹å¤šä¸ªæ„é€ å‡½æ•°éƒ½è¿”å›<code style="color:#ea4335">true</code>
- ç”±äºä»»æ„å¯¹è±¡(é™¤äº†<code style="color:#ea4335">null</code>)éƒ½æ˜¯<code style="color:#ea4335">Object</code>çš„å®ä¾‹,æ‰€ä»¥<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦å¯ä»¥åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºé<code style="color:#ea4335">null</code>çš„å¯¹è±¡

```js
var d = new Date();
d instanceof Date // true
d instanceof Object // true

var obj = { foo: 123 };
obj instanceof Object // true
null instanceof Object // false
```

<code style="color:#ea4335">instanceof</code>çš„åŸç†æ˜¯æ£€æŸ¥å³è¾¹æ„é€ å‡½æ•°çš„<code style="color:#ea4335">prototype</code>å±æ€§,æ˜¯å¦åœ¨å·¦è¾¹æ˜¯åŸå‹é“¾ä¸Š.æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µ,å°±æ˜¯å·¦è¾¹å¯¹è±¡çš„åŸå‹é“¾ä¸Šåªæœ‰<code style="color:#ea4335">null</code>å¯¹è±¡,è¿™æ—¶,<code style="color:#ea4335">instanceof</code>åˆ¤æ–­ä¼šå¤±çœŸ(å”¯ä¸€çš„å¤±çœŸæƒ…å†µ)

```js
var obj = Object.create(null);
typeof obj // "object"
obj instanceof Object // false
```

ğŸ‘†<code style="color:#ea4335">Object.create(null)</code>è¿”å›ä¸€ä¸ªæ–°å¯¹è±¡<code style="color:#ea4335">obj</code>,å®ƒçš„åŸå‹æ˜¯<code style="color:#ea4335">null</code>

å³è¾¹çš„æ„é€ å‡½æ•°<code style="color:#ea4335">Obejct</code>çš„<code style="color:#ea4335">prototype</code>å±æ€§ä¸åœ¨å·¦è¾¹çš„åŸå‹é“¾ä¸Š,å› æ­¤<code style="color:#ea4335">instanceof</code>å°±ä¼šè®¤ä¸º<code style="color:#ea4335">obj</code>ä¸æ˜¯<code style="color:#ea4335">Object</code>çš„å®ä¾‹

- <code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦åªèƒ½ç”¨äºå¯¹è±¡,ä¸ä½¿ç”¨åŸå§‹ç±»å‹çš„å€¼
- å¯¹äº<code style="color:#ea4335">undefined</code>å’Œ<code style="color:#ea4335">null</code>,<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦æ€»æ˜¯è¿”å›<code style="color:#ea4335">false</code>

```js
var x = [1, 2, 3];
var y = {};
x instanceof Array // true
y instanceof Object // true

var s = 'hello';
s instanceof String // false


undefined instanceof Object // false
null instanceof Object // false
```

åˆ©ç”¨<code style="color:#ea4335">instanceof</code>è¿ç®—ç¬¦è¿˜å¯ä»¥è§£å†³è°ƒç”¨æ„é€ å‡½æ•°æ—¶å¿˜è®°åŠ <code style="color:#ea4335">new</code>å‘½ä»¤çš„é—®é¢˜

```js
function Fubar (foo, bar) {
  if (this instanceof Fubar) {
    this._foo = foo;
    this._bar = bar;
  } else {
    return new Fubar(foo, bar);
  }
}
```
